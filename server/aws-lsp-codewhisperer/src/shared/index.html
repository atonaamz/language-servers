<!doctype html>
<html>
    <head>
        <title>AWS CodeWhisperer Logger</title>
        <style>
            :root {
                --aws-orange: #ff9900;
                --aws-blue: #1e88e5;
                --aws-green: #43a047;
                --aws-red: #d32f2f;
                --aws-yellow: #^CFFC107;
                --aws-cyan: #00acc1;
                --aws-dark: #232f3e;
                --aws-light: #f5f5f5;
            }

            body {
                font-family: 'Amazon Ember', Arial, sans-serif;
                margin: 0;
                padding: 0;
                background-color: #fafafa;
                color: #333;
            }

            .header {
                background-color: var(--aws-dark);
                color: white;
                padding: 15px 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .header h1 {
                margin: 0;
                font-size: 1.5rem;
            }

            .controls {
                display: flex;
                gap: 10px;
            }

            .container {
                padding: 20px;
                max-width: 1200px;
                margin: 0 auto;
            }

            .status-bar {
                background-color: var(--aws-light);
                padding: 10px 20px;
                border-bottom: 1px solid #ddd;
                display: flex;
                justify-content: space-between;
            }

            .status {
                display: flex;
                align-items: center;
                gap: 5px;
            }

            .status-indicator {
                width: 10px;
                height: 10px;
                border-radius: 50%;
            }

            .connected {
                background-color: var(--aws-green);
            }
            .disconnected {
                background-color: var(--aws-red);
            }

            .filters {
                display: flex;
                gap: 10px;
                margin-bottom: 15px;
            }

            .filter-btn {
                border: none;
                padding: 5px 10px;
                border-radius: 4px;
                cursor: pointer;
                background-color: var(--aws-light);
            }

            .filter-btn.active {
                background-color: var(--aws-dark);
                color: white;
            }

            .logs-container {
                border: 1px solid #ddd;
                border-radius: 4px;
                overflow: hidden;
            }

            .log-entry {
                border-bottom: 1px solid #eee;
                padding: 0;
                transition: background-color 0.2s;
            }

            .log-entry:last-child {
                border-bottom: none;
            }

            .log-entry:hover {
                background-color: rgba(0, 0, 0, 0.02);
            }

            .log-header {
                padding: 10px 15px;
                cursor: pointer;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .log-api .log-header {
                border-left: 4px solid var(--aws-orange);
            }

            .log-completion .log-header {
                border-left: 4px solid var(--aws-blue);
            }

            .log-edit .log-header {
                border-left: 4px solid var(--aws-green);
            }

            .log-type-badge {
                padding: 3px 8px;
                border-radius: 4px;
                font-size: 0.8rem;
                font-weight: bold;
                color: white;
            }

            .log-api .log-type-badge {
                background-color: var(--aws-orange);
            }

            .log-completion .log-type-badge {
                background-color: var(--aws-blue);
            }

            .log-edit .log-type-badge {
                background-color: var(--aws-green);
            }

            .log-meta {
                display: flex;
                gap: 15px;
                font-size: 0.9rem;
                color: #666;
            }

            .log-content {
                padding: 0 15px 15px;
                display: none;
            }

            .log-entry.expanded .log-content {
                display: block;
            }

            .log-section {
                margin-bottom: 10px;
            }

            .log-section-title {
                font-weight: bold;
                margin-bottom: 5px;
            }

            /* API Log Specific Styles */
            .api-endpoint {
                font-family: monospace;
                padding: 5px;
                background-color: #f0f0f0;
                border-radius: 3px;
            }

            .api-status {
                padding: 2px 6px;
                border-radius: 3px;
                font-weight: bold;
            }

            .api-status-success {
                background-color: rgba(67, 160, 71, 0.2);
                color: var(--aws-green);
            }

            .api-status-error {
                background-color: rgba(211, 47, 47, 0.2);
                color: var(--aws-red);
            }

            /* Completion Log Specific Styles */
            .completion-file {
                font-family: monospace;
            }

            .completion-position {
                font-family: monospace;
                background-color: #f0f0f0;
                padding: 2px 4px;
                border-radius: 3px;
            }

            .completion-line {
                font-family: monospace;
                padding: 8px;
                background-color: #f5f5f5;
                border-left: 3px solid var(--aws-blue);
                white-space: pre;
                overflow-x: auto;
            }

            /* Edit Log Specific Styles */
            .edit-trigger {
                font-weight: bold;
            }

            .edit-trigger-yes {
                color: var(--aws-green);
            }

            .edit-trigger-no {
                color: var(--aws-red);
            }

            .edit-conditions {
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
                margin-top: 5px;
            }

            .edit-condition {
                background-color: rgba(255, 193, 7, 0.2);
                color: #996000;
                padding: 2px 6px;
                border-radius: 3px;
                font-size: 0.8rem;
            }

            .edit-code {
                font-family: monospace;
                padding: 8px;
                background-color: #f5f5f5;
                border-left: 3px solid var(--aws-green);
                white-space: pre;
                overflow-x: auto;
            }

            /* JSON Viewer */
            .json-viewer {
                font-family: monospace;
                font-size: 0.9rem;
                background-color: #f8f8f8;
                border-radius: 4px;
                padding: 10px;
                overflow-x: auto;
            }

            .json-key {
                color: var(--aws-dark);
                font-weight: bold;
            }

            .json-string {
                color: var(--aws-green);
            }

            .json-number {
                color: var(--aws-blue);
            }

            .json-boolean {
                color: var(--aws-orange);
            }

            .json-null {
                color: var(--aws-red);
            }

            /* Buttons */
            button {
                background-color: var(--aws-orange);
                border: none;
                color: white;
                padding: 8px 16px;
                cursor: pointer;
                border-radius: 4px;
                font-weight: 500;
                transition: background-color 0.2s;
            }

            button:hover {
                background-color: #ec7211;
            }

            button.secondary {
                background-color: var(--aws-dark);
            }

            button.secondary:hover {
                background-color: #1a242f;
            }
        </style>
    </head>
    <body>
        <div class="header">
            <h1>AWS CodeWhisperer Logger</h1>
            <div class="controls">
                <button id="clearBtn">Clear Logs</button>
                <button id="reconnectBtn" class="secondary">Reconnect</button>
            </div>
        </div>

        <div class="status-bar">
            <div class="status">
                Status: <span class="status-indicator" id="statusIndicator"></span>
                <span id="statusText">Disconnected</span>
            </div>
            <div class="log-count">Logs: <span id="logCount">0</span></div>
        </div>

        <div class="container">
            <div class="filters">
                <button class="filter-btn active" data-type="all">All</button>
                <button class="filter-btn" data-type="api">API</button>
                <button class="filter-btn" data-type="completion">Completion</button>
                <button class="filter-btn" data-type="edit">Edit</button>
            </div>

            <div id="logs" class="logs-container"></div>
        </div>

        <script>
            const logsContainer = document.getElementById('logs')
            const statusIndicator = document.getElementById('statusIndicator')
            const statusText = document.getElementById('statusText')
            const logCountEl = document.getElementById('logCount')
            const clearBtn = document.getElementById('clearBtn')
            const reconnectBtn = document.getElementById('reconnectBtn')
            const filterBtns = document.querySelectorAll('.filter-btn')

            let ws
            let currentFilter = 'all'
            let allLogs = []

            // Set up filter buttons
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterBtns.forEach(b => b.classList.remove('active'))
                    btn.classList.add('active')
                    currentFilter = btn.dataset.type
                    renderLogs()
                })
            })

            function connect() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:'
                ws = new WebSocket(`${protocol}//${window.location.host}/ws`)

                ws.onopen = () => {
                    console.log('Connected to WebSocket server')
                    statusIndicator.className = 'status-indicator connected'
                    statusText.textContent = 'Connected'

                    // Request all existing logs
                    ws.send(JSON.stringify({ type: 'getAll' }))
                }

                ws.onmessage = event => {
                    const message = JSON.parse(event.data)

                    if (message.type === 'log') {
                        addLogEntry(message.data)
                    } else if (message.type === 'clear') {
                        allLogs = []
                        renderLogs()
                    } else if (message.type === 'getAll') {
                        allLogs = message.data
                        renderLogs()
                    }
                }

                ws.onclose = () => {
                    console.log('Disconnected from WebSocket server')
                    statusIndicator.className = 'status-indicator disconnected'
                    statusText.textContent = 'Disconnected'

                    // Try to reconnect after 5 seconds
                    setTimeout(connect, 5000)
                }

                ws.onerror = error => {
                    console.error('WebSocket error:', error)
                }
            }

            function addLogEntry(log) {
                // Add to our local array
                allLogs.unshift(log) // Add to beginning
                renderLogs()
            }

            function renderLogs() {
                // Filter logs based on current filter
                const filteredLogs =
                    currentFilter === 'all' ? allLogs : allLogs.filter(log => log.logData.type === currentFilter)

                // Update log count
                logCountEl.textContent = filteredLogs.length

                // Clear container
                logsContainer.innerHTML = ''

                // Render logs
                filteredLogs.forEach(log => {
                    const entry = document.createElement('div')
                    entry.className = `log-entry log-${log.logData.type}`

                    const header = document.createElement('div')
                    header.className = 'log-header'

                    const time = new Date(log.timestamp).toLocaleTimeString()

                    // Create header content based on log type
                    let headerContent = ''
                    let detailContent = ''

                    switch (log.logData.type) {
                        case 'api':
                            const apiData = log.logData.data
                            const statusClass =
                                apiData.statusCode >= 200 && apiData.statusCode < 300
                                    ? 'api-status-success'
                                    : 'api-status-error'

                            headerContent = `
                            <div>
                                <span class="log-type-badge">API</span>
                                <span class="api-endpoint">${apiData.endpoint}</span>
                                <span class="api-status ${statusClass}">${apiData.statusCode || 'N/A'}</span>
                            </div>
                            <div class="log-meta">
                                <span>ID: ${log.id.substring(0, 8)}...</span>
                                <span>Time: ${time}</span>
                                ${apiData.latency ? `<span>Latency: ${apiData.latency}ms</span>` : ''}
                            </div>
                        `

                            detailContent = `
                            <div class="log-section">
                                <div class="log-section-title">Request</div>
                                <div class="json-viewer">${formatJSON(apiData.request)}</div>
                            </div>
                            <div class="log-section">
                                <div class="log-section-title">Response</div>
                                <div class="json-viewer">${formatJSON(apiData.response)}</div>
                            </div>
                            ${
                                apiData.error
                                    ? `
                                <div class="log-section">
                                    <div class="log-section-title">Error</div>
                                    <div class="json-viewer">${apiData.error}</div>
                                </div>
                            `
                                    : ''
                            }
                            ${
                                apiData.metadata
                                    ? `
                                <div class="log-section">
                                    <div class="log-section-title">Metadata</div>
                                    <div class="json-viewer">${formatJSON(apiData.metadata)}</div>
                                </div>
                            `
                                    : ''
                            }
                        `
                            break

                        case 'completion':
                            const compData = log.logData.data
                            const fileName = compData.textDocument.uri.split('/').pop() || ''

                            headerContent = `
                            <div>
                                <span class="log-type-badge">COMPLETION</span>
                                <span class="completion-file">${fileName}</span>
                                <span class="completion-position">Line ${compData.position.line}:${compData.position.character}</span>
                            </div>
                            <div class="log-meta">
                                <span>ID: ${log.id.substring(0, 8)}...</span>
                                <span>Time: ${time}</span>
                                ${compData.suggestionCount ? `<span>Suggestions: ${compData.suggestionCount}</span>` : ''}
                            </div>
                        `

                            detailContent = `
                            ${
                                compData.documentContent?.currentLine
                                    ? `
                                <div class="log-section">
                                    <div class="log-section-title">Current Line</div>
                                    <div class="completion-line">${escapeHTML(compData.documentContent.currentLine)}</div>
                                </div>
                            `
                                    : ''
                            }
                            <div class="log-section">
                                <div class="log-section-title">Document</div>
                                <div class="json-viewer">${formatJSON(compData.textDocument)}</div>
                            </div>
                            ${
                                compData.context
                                    ? `
                                <div class="log-section">
                                    <div class="log-section-title">Context</div>
                                    <div class="json-viewer">${formatJSON(compData.context)}</div>
                                </div>
                            `
                                    : ''
                            }
                            ${
                                compData.documentContent
                                    ? `
                                <div class="log-section">
                                    <div class="log-section-title">Document Content</div>
                                    <div class="json-viewer">${formatJSON(compData.documentContent)}</div>
                                </div>
                            `
                                    : ''
                            }
                            ${
                                compData.responseContext
                                    ? `
                                <div class="log-section">
                                    <div class="log-section-title">Response Context</div>
                                    <div class="json-viewer">${formatJSON(compData.responseContext)}</div>
                                </div>
                            `
                                    : ''
                            }
                        `
                            break

                        case 'edit':
                            const editData = log.logData.data
                            const triggerClass = editData.shouldTrigger ? 'edit-trigger-yes' : 'edit-trigger-no'

                            headerContent = `
                            <div>
                                <span class="log-type-badge">EDIT</span>
                                <span class="edit-trigger ${triggerClass}">
                                    ${editData.shouldTrigger ? 'Triggered' : 'Not Triggered'}
                                </span>
                                ${editData.filename ? `<span class="completion-file">${editData.filename.split('/').pop()}</span>` : ''}
                            </div>
                            <div class="log-meta">
                                <span>ID: ${log.id.substring(0, 8)}...</span>
                                <span>Time: ${time}</span>
                                ${editData.language ? `<span>Language: ${editData.language}</span>` : ''}
                            </div>
                        `

                            // Collect conditions
                            const conditions = []
                            if (editData.hasRecentEdit) conditions.push('Recent Edit')
                            if (editData.isNotInMiddleOfWord) conditions.push('Not In Word')
                            if (editData.isPreviousDecisionNotReject) conditions.push('Not Rejected')
                            if (editData.hasNonEmptySuffix) conditions.push('Has Suffix')
                            if (editData.isAfterKeyword) conditions.push('After Keyword')
                            if (editData.isAfterOperatorOrDelimiter) conditions.push('After Operator/Delimiter')
                            if (editData.hasUserPaused) conditions.push('User Paused')
                            if (editData.isAtLineBeginning) conditions.push('At Line Beginning')

                            detailContent = `
                            <div class="log-section">
                                <div class="log-section-title">Conditions</div>
                                <div>Required: ${editData.requiredConditionsMet ? 'Met' : 'Not Met'}</div>
                                <div>Optional: ${editData.optionalConditionsMet ? 'Met' : 'Not Met'}</div>
                                <div class="edit-conditions">
                                    ${conditions.map(c => `<span class="edit-condition">${c}</span>`).join('')}
                                </div>
                            </div>
                            ${
                                editData.currentLine
                                    ? `
                                <div class="log-section">
                                    <div class="log-section-title">Current Line</div>
                                    <div class="edit-code">${escapeHTML(editData.currentLine)}</div>
                                </div>
                            `
                                    : ''
                            }
                            ${
                                editData.cursor
                                    ? `
                                <div class="log-section">
                                    <div class="log-section-title">Cursor</div>
                                    <div class="edit-code">${escapeHTML(editData.cursor)}</div>
                                </div>
                            `
                                    : ''
                            }
                            <div class="log-section">
                                <div class="log-section-title">Full Data</div>
                                <div class="json-viewer">${formatJSON(editData)}</div>
                            </div>
                        `
                            break
                    }

                    header.innerHTML = headerContent

                    const content = document.createElement('div')
                    content.className = 'log-content'
                    content.innerHTML = detailContent

                    entry.appendChild(header)
                    entry.appendChild(content)

                    // Toggle expanded state on click
                    header.addEventListener('click', () => {
                        entry.classList.toggle('expanded')
                    })

                    logsContainer.appendChild(entry)
                })
            }

            function formatJSON(obj) {
                if (obj === null) return '<span class="json-null">null</span>'
                if (obj === undefined) return '<span class="json-null">undefined</span>'

                try {
                    // For strings that are already JSON
                    if (typeof obj === 'string') {
                        try {
                            obj = JSON.parse(obj)
                        } catch (e) {
                            // Not JSON, keep as string
                        }
                    }

                    const formatted = JSON.stringify(obj, null, 2)
                        .replace(/&/g, '&')
                        .replace(/</g, '<')
                        .replace(/>/g, '>')
                        .replace(
                            /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
                            function (match) {
                                let cls = 'json-number'
                                if (/^"/.test(match)) {
                                    if (/:$/.test(match)) {
                                        cls = 'json-key'
                                        // Remove quotes and colon from key
                                        match = match.replace(/[":]/g, '')
                                    } else {
                                        cls = 'json-string'
                                    }
                                } else if (/true|false/.test(match)) {
                                    cls = 'json-boolean'
                                } else if (/null/.test(match)) {
                                    cls = 'json-null'
                                }
                                return '<span class="' + cls + '">' + match + '</span>'
                            }
                        )

                    return formatted
                } catch (e) {
                    return String(obj).replace(/&/g, '&').replace(/</g, '<').replace(/>/g, '>')
                }
            }

            function escapeHTML(str) {
                return String(str)
                    .replace(/&/g, '&')
                    .replace(/</g, '<')
                    .replace(/>/g, '>')
                    .replace(/"/g, '"')
                    .replace(/'/g, '&#39;')
            }

            clearBtn.addEventListener('click', () => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'clear' }))
                }
            })

            reconnectBtn.addEventListener('click', () => {
                if (ws) {
                    ws.close()
                }
                connect()
            })

            // Initial connection
            connect()
        </script>
    </body>
</html>
